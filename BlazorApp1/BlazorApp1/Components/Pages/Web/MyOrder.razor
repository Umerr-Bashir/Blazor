@page "/my-order"
@using BlazorApp1.Components.Shared
@using BlazorApp1.DTOs
@using BlazorApp1.Services
@using ECommerceApp.DTOs.AddressesDTOs
@using ECommerceApp.DTOs.OrderDTOs
@using ECommerceApp.DTOs.PaymentDTOs
@using ECommerceApp.DTOs.ProductDTOs
@using ECommerceApp.Models
@layout BlazorApp1.Components.Layout.WebLayout
@rendermode InteractiveServer
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage;
@inject NavigationManager Nav
@inject OrderService OrderService
@inject AddressService AddressService
@inject ProductService ProductService
@inject PaymentService PaymentService
@inject IJSRuntime JS;

@if (isPageLoading)
{
    <Loader/>
}
else
{
    <h3><b>My Orders</b></h3>

    @if (alert != null)
    {
        <div class="alert alert-success">
            @alert
        </div>
    }
    @if (errorAlert != null)
    {
        <div class="alert alert-danger">
            @errorAlert
        </div>
    }
    @* Order Details Tickets *@
    <div class="orders-container my-4">
        @if (orders != null && orders.Any())
        {
            @foreach (var order in orders)
            {
                <div class="order-card shadow-sm mb-4 p-3">

                    <!-- Order Header -->
                    <div class="order-header mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold">Order #@order.OrderNumber</h5>
                            <p class="text-muted small mb-0">Placed on @order.OrderDate.ToString("dd MMM yyyy")</p>
                        </div>
                        <span class="badge bg-info">@order.OrderStatus</span>
                    </div>

                    <hr />

                    <!-- Billing & Shipping -->
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <strong>Billing:</strong>
                            <p class="small mb-0">
                                @BillingAddresses[order.Id]?.Data?.PresentAddress <br />
                                @BillingAddresses[order.Id]?.Data?.City, @BillingAddresses[order.Id]?.Data?.State <br />
                                @BillingAddresses[order.Id]?.Data?.Country - @BillingAddresses[order.Id]?.Data?.PostalCode
                            </p>
                        </div>
                        <div class="col-md-6">
                            <strong>Shipping:</strong>
                            <p class="small mb-0">
                                @ShippingAddresses[order.Id]?.Data?.PresentAddress <br />
                                @ShippingAddresses[order.Id]?.Data?.City, @ShippingAddresses[order.Id]?.Data?.State <br />
                                @ShippingAddresses[order.Id]?.Data?.Country - @ShippingAddresses[order.Id]?.Data?.PostalCode
                            </p>
                        </div>
                    </div>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="10">Product</th>
                                <th>Name</th>
                                <th class="text-center">Qty</th>
                                <th class="text-center">Price</th>
                                <th class="text-center">Discount</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var item in order.OrderItems)
                            {
                                <tr>
                                    <img src="@($"https://localhost:7087{ProductDetails[item.ProductId].Data.ImageUrl}")" height="90" class="card-img-top" alt="@ProductDetails[item.ProductId].Data.Name" />
                                    <td>@ProductDetails[item.ProductId].Data.Name</td>
                                    <td class="text-center">@((int)item.Quantity)</td>
                                    <td class="text-center">@((int)item.UnitPrice) PKR</td>
                                    <td class="text-center">@((int)item.Discount) PKR</td>
                                    <td class="text-end">@((int)item.TotalPrice) PKR</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sub Total</th>
                                <th class="text-center">Discount</th>
                                <th class="text-center">Shipping</th>
                                <th class="text-end">Total Amount</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr>
                                <td>@order.TotalBaseAmount PKR</td>
                                <td class="text-center text-success">@((int)order.TotalDiscountAmount) PKR</td>
                                <td class="text-center"><span class="text-danger">-@((int)order.ShippingCost)</span> PKR</td>
                                <td class="text-end"><b>@order.TotalAmount PKR </b></td>
                            </tr>
                        </tbody>
                    </table>

                    @if (order.OrderStatus.ToString().ToLower() == "Pending".ToLower())
                    {
                        <button class="btn btn-success btn-sm float-end mt-2" @onclick="() => OpenPaymentModal(order)">
                            <i class="bi bi-credit-card"></i> Pay Now
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-primary btn-sm float-end mt-2" @onclick="() => PaymentDetails(order.Id)">
                            <i class="bi"></i> Payment Details
                        </button>
                    }
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">No orders found.</p>
        }
    </div>

    @* Payment Modal *@
    <BlazorModal Title="Make Payment" IsVisible="@isPaymentModalOpen" OnClose="ClosePaymentModal">
        <Body>
            <EditForm Model="@paymentRequest" OnValidSubmit="SubmitPayment">
                <DataAnnotationsValidator />

                <h5 class="fw-bold mb-2 text-center">
                    Order #@orders?.FirstOrDefault(o => o.Id == paymentRequest.OrderId)?.OrderNumber
                </h5>

                <div class="text-center mt-3 mb-4">
                    <i class="bi bi-cash-coin payment-icon"></i>
                </div>

                <h5 class="mb-3">Select Payment Method</h5>

                <div class="payment-options d-flex flex-wrap">
                    @foreach (var method in paymentMethods)
                    {
                        <div class="payment-box @(paymentRequest.PaymentMethod == method ? "selected" : "")"
                             @onclick="() => SelectMethod(method)">
                            <img src="@paymentIcons[method]" class="pay-icon me-2" height="25" width="25" />
                            <span>@method</span>
                        </div>
                    }
                </div>

                <hr />

                @{
                    var selectedOrder = orders?.FirstOrDefault(o => o.Id == paymentRequest.OrderId);
                }


                @if (isLoading)
                {
                    <Loader />
                }
                else
                {
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <p>Sub Total</p>
                            <p>Discount</p>
                            <p>Shipping</p>
                            <p>Total Amount</p>
                        </div>

                        <div class="col-md-6 text-end">
                            <p>@selectedOrder?.TotalBaseAmount PKR</p>
                            <p>@selectedOrder?.TotalDiscountAmount PKR</p>
                            <p>@selectedOrder?.ShippingCost PKR</p>
                            <p><strong>@selectedOrder?.TotalAmount PKR</strong></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="ClosePaymentModal">Close</button>
                        <button class="btn btn-success">Pay Now</button>
                    </div>
                }

            </EditForm>

        </Body>

    </BlazorModal>


}

<style>
    .payment-icon {
        font-size: 45px;
        color: #28a745; /* green */
        opacity: 0.8;
    }

    .orders-container {
        display: flex;
        flex-direction: column;
    }

    .order-card {
        width: 100%;
        background: #fff;
        border-radius: 15px;
        border: 2px dashed #ccc;
    }

    .order-header .badge {
        font-size: 0.9rem;
    }

    .summary-section div {
        margin-bottom: 6px;
    }

    @* Payment *@
    .payment-options {
        gap: 12px;
    }

    .payment-box {
        padding: 12px 20px;
        border: 2px solid #ccc;
        border-radius: 10px;
        cursor: pointer;
        min-width: 120px;
        text-align: center;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }

        .payment-box:hover {
            border-color: #0d6efd;
        }

        .payment-box.selected {
            border-color: #198754;
            background-color: #eafaf1;
        }


        .payment-box:hover {
            border-color: #0d6efd;
            background: #f1f7ff;
        }

        .payment-box.selected {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

    .pay-icon {
        object-fit: contain;
        margin-bottom: 8px;
    }
</style>



@code {
    private List<OrderResponseDTO> orders = new();
    private Dictionary<int, ApiResponse<AddressResponseDTO>?> BillingAddresses = new();
    private Dictionary<int, ApiResponse<AddressResponseDTO>?> ShippingAddresses = new();
    private Dictionary<int, ApiResponse<ProductResponseDTO>> ProductDetails = new();
    private string? errorAlert;
    private bool loaded = false;
    private bool isLoading = false;
    private bool isPageLoading = true;
    private int userId;
    private string? authToken;
    private string? alert;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender && !loaded)
        {
            userId = await LocalStorage.GetItemAsync<int>("userId");
            authToken = await LocalStorage.GetItemAsync<string>("authToken");

            if (userId.ToString() != null && authToken != null)
            {
                await getOrdersByCustomer();
                isPageLoading = false;
            }
            else
            {
                Nav.NavigateTo("/login", true); // true = force reload
            }
            StateHasChanged();
        }
    }


    private async Task getOrdersByCustomer()
    {
        var response = await OrderService.GetOrderByCustomerId(userId); // Now returns list

        if (response?.Success == true && response.Data != null && response.Data.Any())
        {
            orders = response.Data.OrderByDescending(o => o.Id).ToList();   // Store list of orders

            foreach (var order in orders)
            {
                var billing = await AddressService.GetAddressByIdAsync(order.BillingAddressId);
                var shipping = await AddressService.GetAddressByIdAsync(order.ShippingAddressId);

                if (billing == null || shipping == null)
                {
                    errorAlert = "One or more addresses are missing.";
                }

                BillingAddresses[order.Id] = billing;
                ShippingAddresses[order.Id] = shipping;

                foreach (var item in order.OrderItems)
                {
                    var product = await ProductService.GetProductByIdAsync(item.ProductId);
                    ProductDetails[item.ProductId] = product;
                }
            }

        }
        else
        {
            errorAlert = "No Orders Found.";
        }

    }
    private void PayOrder(int Id)
    {

    }


    bool isPaymentModalOpen = false;

    private PaymentRequestDTO paymentRequest = new();

    List<string> paymentMethods = new()
    {
        "Cash on Delivery",
        "VISA",
        "Mastercard",
        "JazzCash",
        "Easypaisa"
    };
    Dictionary<string, string> paymentIcons = new()
    {
        { "Cash on Delivery", "https://th.bing.com/th/id/OIP.0QTwObaauPQ1UppvH7syUAHaHa?w=199&h=199&c=7&r=0&o=7&cb=ucfimgc2&dpr=1.4&pid=1.7&rm=3" },
        { "VISA", "https://www.bing.com/th/id/OIP.hZnh7WR7hlMrODsM3FHS9wHaHa?w=183&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" },
        { "Mastercard", "https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" },
        { "JazzCash", "https://www.bing.com/th/id/OIP.05InOB5Bm1QISVw_MPAqjgHaHa?w=183&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" },
        { "Easypaisa", "https://www.bing.com/th/id/OIP.QcS8e3iGamNXsvBeJKd3FQHaHa?w=195&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" }
    };


    private void OpenPaymentModal(OrderResponseDTO order)
    {
        paymentRequest.CustomerId = userId;
        paymentRequest.OrderId = order.Id;
        paymentRequest.Amount = order.TotalAmount;

        isPaymentModalOpen = true;
    }

    void ClosePaymentModal()
    {
        isPaymentModalOpen = false;
    }

    void PaymentDetails(int Id)
    {
        Nav.NavigateTo($"/payment-details/{Id}");
    }
    void SelectMethod(string method)
    {
        paymentRequest.PaymentMethod = method;
    }
    private async Task SubmitPayment()
    {
        if (string.IsNullOrEmpty(paymentRequest.PaymentMethod))
        {
            alert = "Please select a payment method.";
            StateHasChanged();
            return;
        }

        try
        {
            isLoading = true;
            alert = null;
            StateHasChanged();

            var response = await PaymentService.ProcessPaymentAsync(paymentRequest);

            if (response?.Success == true)
            {
                alert = "Payment successful!";
                var order = orders.FirstOrDefault(o => o.Id == paymentRequest.OrderId);
                if (order != null)
                {
                    order.OrderStatus = OrderStatus.Processing;
                }
            }
            else
            {
                errorAlert = $"{response?.Errors}";
            }
        }
        catch (Exception ex)
        {
            alert = $"Payment error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            isPaymentModalOpen = false;
            StateHasChanged(); 
        }
    }



}
