@page "/my-order"
@layout BlazorApp1.Components.Layout.WebLayout
@rendermode InteractiveServer
@inject IJSRuntime JS;
@using BlazorApp1.Components.Shared
@using BlazorApp1.DTOs
@using BlazorApp1.Services
@using ECommerceApp.DTOs.AddressesDTOs
@using ECommerceApp.DTOs.CancellationDTOs
@using ECommerceApp.DTOs.FeedbackDTOs
@using ECommerceApp.DTOs.OrderDTOs
@using ECommerceApp.DTOs.PaymentDTOs
@using ECommerceApp.DTOs.ProductDTOs
@using ECommerceApp.Models
@using EcommerceApp.DTOs.PaymentDTO
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage;
@inject NavigationManager Nav
@inject OrderService OrderService
@inject AddressService AddressService
@inject ProductService ProductService
@inject PaymentService PaymentService
@inject CancellationService CancellationService
@inject FeedbackService FeedbackService

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


@if (isPageLoading)
{
    <Loader />
}
else
{
    <h3><b>My Orders</b></h3>

    @if (alert != null)
    {
        <div class="alert alert-success">
            @alert
        </div>
    }
    @if (errorAlert != null)
    {
        <div class="alert alert-danger">
            @errorAlert
        </div>
    }
    @* Order Details Tickets *@
    <div class="orders-container my-4">
        @if (orders != null && orders.Any())
        {
            @foreach (var order in orders)
            {
                <div class="order-card shadow-sm mb-4 p-3">

                    <!-- Order Header -->
                    <div class="order-header mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold">Order #@order.OrderNumber</h5>
                            <p class="text-muted small mb-0">Placed on @order.OrderDate.ToString("dd MMM yyyy")</p>
                        </div>
                        <span class="badge bg-info">@order.OrderStatus</span>
                    </div>

                    <hr />

                    <!-- Billing & Shipping -->
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <strong>Billing:</strong>
                            <p class="small mb-0">
                                @BillingAddresses[order.Id]?.Data?.PresentAddress <br />
                                @BillingAddresses[order.Id]?.Data?.City, @BillingAddresses[order.Id]?.Data?.State <br />
                                @BillingAddresses[order.Id]?.Data?.Country - @BillingAddresses[order.Id]?.Data?.PostalCode
                            </p>
                        </div>
                        <div class="col-md-6">
                            <strong>Shipping:</strong>
                            <p class="small mb-0">
                                @ShippingAddresses[order.Id]?.Data?.PresentAddress <br />
                                @ShippingAddresses[order.Id]?.Data?.City, @ShippingAddresses[order.Id]?.Data?.State <br />
                                @ShippingAddresses[order.Id]?.Data?.Country - @ShippingAddresses[order.Id]?.Data?.PostalCode
                            </p>
                        </div>
                    </div>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="10">Product</th>
                                <th>Name</th>
                                <th class="text-center">Qty</th>
                                <th class="text-center">Price</th>
                                <th class="text-center">Discount</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var item in order.OrderItems)
                            {
                                <tr>
                                    <img src="@($"https://localhost:7087{ProductDetails[item.ProductId].Data.ImageUrl}")" height="90" class="card-img-top" alt="@ProductDetails[item.ProductId].Data.Name" />
                                    <td>@ProductDetails[item.ProductId].Data.Name</td>
                                    <td class="text-center">@((int)item.Quantity)</td>
                                    <td class="text-center">@((int)item.UnitPrice) PKR</td>
                                    <td class="text-center">@((int)item.Discount) PKR</td>
                                    <td class="text-end">@((int)item.TotalPrice) PKR</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sub Total</th>
                                <th class="text-center">Discount</th>
                                <th class="text-center">Shipping</th>
                                <th class="text-end">Total Amount</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr>
                                <td>@order.TotalBaseAmount PKR</td>
                                <td class="text-center text-success">@((int)order.TotalDiscountAmount) PKR</td>
                                <td class="text-center"><span class="text-danger">-@((int)order.ShippingCost)</span> PKR</td>
                                <td class="text-end"><b>@order.TotalAmount PKR </b></td>
                            </tr>
                        </tbody>
                    </table>

                    @if (order.OrderStatus.ToString().ToLower() == "Pending".ToLower())
                    {
                        <button class="btn btn-success btn-sm float-end mt-2" @onclick="() => OpenPaymentModal(order)">
                            <i class="bi bi-credit-card"></i> Pay Now
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-primary btn-sm float-end mt-2" @onclick="() => PaymentDetails(order.Id)">
                            <i class="bi"></i> Payment Details
                        </button>

                        <button class="btn btn-primary btn-sm float-start mt-2" @onclick="() => OpenFeedbackModal(order)">
                            <i class="bi"></i> Feedback
                        </button>

                        @if (!isFeedback)
                        {
                            
                        }
                        <button class="btn btn-success btn-sm float-start mt-2">
                            <i class="bi"></i> Feedback Submitted
                        </button>

                        if (order.OrderStatus.ToString().ToLower() != "Shipped".ToLower() || order.OrderStatus.ToString().ToLower() != "Canceled".ToLower())
                        {
                            <button class="btn btn-danger btn-sm float-end mt-2 me-2" @onclick="() => OpenCancelModal(order.Id, order.CustomerId)">
                                <i class="bi"></i> Cancel Order
                            </button>
                        }
                    }
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">No orders found.</p>
        }
    </div>

    @* Payment Modal *@
    <BlazorModal Title="Make Payment" IsVisible="@isPaymentModalOpen" OnClose="ClosePaymentModal">
        <Body>
            <EditForm Model="@paymentRequest" OnValidSubmit="SubmitPayment">
                <DataAnnotationsValidator />

                <h5 class="fw-bold mb-2 text-center">
                    Order #@orders?.FirstOrDefault(o => o.Id == paymentRequest.OrderId)?.OrderNumber
                </h5>

                <div class="text-center mt-3 mb-4">
                    <i class="bi bi-cash-coin payment-icon"></i>
                </div>

                <h5 class="mb-3">Select Payment Method</h5>

                <div class="payment-options d-flex flex-wrap">
                    @foreach (var method in paymentMethods)
                    {
                        <div class="payment-box @(paymentRequest.PaymentMethod == method ? "selected" : "")"
                             @onclick="() => SelectMethod(method)">
                            <img src="@paymentIcons[method]" class="pay-icon me-2" height="25" width="25" />
                            <span>@method</span>
                        </div>
                    }
                </div>

                <hr />

                @{
                    var selectedOrder = orders?.FirstOrDefault(o => o.Id == paymentRequest.OrderId);
                }


                @if (isLoading)
                {
                    <Loader />
                }
                else
                {
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <p>Sub Total</p>
                            <p>Discount</p>
                            <p>Shipping</p>
                            <p>Total Amount</p>
                        </div>

                        <div class="col-md-6 text-end">
                            <p>@selectedOrder?.TotalBaseAmount PKR</p>
                            <p>@selectedOrder?.TotalDiscountAmount PKR</p>
                            <p>@selectedOrder?.ShippingCost PKR</p>
                            <p><strong>@selectedOrder?.TotalAmount PKR</strong></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="ClosePaymentModal">Close</button>
                        <button class="btn btn-success">Pay Now</button>
                    </div>
                }

            </EditForm>

        </Body>

    </BlazorModal>

    @* Cancel Order *@
    <BlazorModal Title="Cancel Order" IsVisible="@isCancelModalOpen" OnClose="CloseCancelModal">
        <Body>
            <EditForm Model="@cancelRequest" OnValidSubmit="SubmitCancellation">
                <DataAnnotationsValidator />
                <ValidationSummary />

                @* Display Order Info *@
                <h5 class="fw-bold mb-2 text-center">
                    Cancel Order #@orders?.FirstOrDefault(o => o.Id == cancelRequest.OrderId)?.OrderNumber
                </h5>

                <div class="text-center mt-3 mb-4">
                    <i class="bi bi-x-circle-fill cancel-icon"></i>
                </div>

                <p class="mb-2 text-center">Please provide a reason for canceling this order:</p>

                <div class="mb-3">
                    <InputTextArea class="form-control"
                                   @bind-Value="cancelRequest.Reason"
                                   placeholder="Enter reason..." rows="4" />
                </div>

                <hr />

                @* Display Order Summary *@
                @{
                    var selectedOrder = orders?.FirstOrDefault(o => o.Id == cancelRequest.OrderId);
                }

                @if (selectedOrder != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p>Sub Total</p>
                            <p>Discount</p>
                            <p>Shipping</p>
                            <p>Total Amount</p>
                        </div>

                        <div class="col-md-6 text-end">
                            <p>@selectedOrder.TotalBaseAmount PKR</p>
                            <p>@selectedOrder.TotalDiscountAmount PKR</p>
                            <p>@selectedOrder.ShippingCost PKR</p>
                            <p><strong>@selectedOrder.TotalAmount PKR</strong></p>
                        </div>
                    </div>
                }

                <div class="modal-footer d-flex justify-content-between">
                    <button class="btn btn-secondary" @onclick="CloseCancelModal">Close</button>
                    <button class="btn btn-danger" type="submit">
                        <i class="bi bi-x-circle me-1"></i> Cancel Order
                    </button>
                </div>
            </EditForm>
        </Body>
    </BlazorModal>
}

@* Feedback Modal *@
@* Cancel Modal *@
<BlazorModal Title="Feedback" IsVisible="@isFeedbackModalOpen" OnClose="CloseFeedbackModal">

    <Body>
        @if (isLoading)
        {
            <Loader />
        }
        else
        {
            <EditForm Model="@feedbackRequest" OnValidSubmit="SubmitFeedBack">
                <DataAnnotationsValidator />

                <!-- PRODUCT DROPDOWN -->
                <div class="dropdown mb-3">
                    <button class="btn btn-sm btn-primary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        @(feedbackRequest.ProductId == 0
                                            ? "Select Product"
                                            : ProductDetails[feedbackRequest.ProductId].Data.Name)
                </button>

                @{
                        var orderly = orders.FirstOrDefault(p => p.Id == orderId);
                    }

                    <ul class="dropdown-menu">
                        @foreach (var item in orderly.OrderItems)
                        {
                            <li>
                                <a class="dropdown-item"
                                   @onclick="() => SelectProduct(item.ProductId)">
                                    @ProductDetails[item.ProductId].Data.Name
                                </a>
                            </li>
                        }
                    </ul>
                </div>

                <!-- STAR RATING -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Rating</label><br />

                    @for (int i = 1; i <= 5; i++)
                    {
                        <span class="star"
                              style="font-size: 28px; cursor: pointer; color:@(feedbackRequest.Rating >= i ? "#FFD700" : "#ccc")"
                              @onclick="() => SelectRating(i)">
                            &#9733;
                        </span>
                    }
                </div>

                <!-- COMMENT -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Comment</label>
                    <textarea class="form-control"
                              rows="4"
                              @bind="feedbackRequest.Comment">
                </textarea>
                </div>

                <!-- SUBMIT BUTTON -->
                <button type="submit" class="btn btn-success w-100" @onclick="SubmitFeedBack">
                    Submit Feedback
                </button>

            </EditForm>
        }

    </Body>

</BlazorModal>

<style>
    .cancel-icon {
        font-size: 3rem;
        color: #dc3545;
    }

    .modal-footer button {
        min-width: 120px;
    }

    .payment-icon {
        font-size: 45px;
        color: #28a745; /* green */
        opacity: 0.8;
    }

    .orders-container {
        display: flex;
        flex-direction: column;
    }

    .order-card {
        width: 100%;
        background: #fff;
        border-radius: 15px;
        border: 2px dashed #ccc;
    }

    .order-header .badge {
        font-size: 0.9rem;
    }

    .summary-section div {
        margin-bottom: 6px;
    }

    @* Payment *@
    .payment-options {
        gap: 12px;
    }

    .payment-box {
        padding: 12px 20px;
        border: 2px solid #ccc;
        border-radius: 10px;
        cursor: pointer;
        min-width: 120px;
        text-align: center;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }

        .payment-box:hover {
            border-color: #0d6efd;
        }

        .payment-box.selected {
            border-color: #198754;
            background-color: #eafaf1;
        }


        .payment-box:hover {
            border-color: #0d6efd;
            background: #f1f7ff;
        }

        .payment-box.selected {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

    .pay-icon {
        object-fit: contain;
        margin-bottom: 8px;
    }
</style>



@code {
    private List<OrderResponseDTO> orders = new();
    private Dictionary<int, ApiResponse<AddressResponseDTO>?> BillingAddresses = new();
    private Dictionary<int, ApiResponse<AddressResponseDTO>?> ShippingAddresses = new();
    private Dictionary<int, ApiResponse<ProductResponseDTO>> ProductDetails = new();
    private string? errorAlert;
    private bool loaded = false;
    private bool isLoading = false;
    private bool isFeedback = false;
    private bool isPageLoading = true;
    private int userId;
    private int orderId;
    private string? authToken;
    private string? alert;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender && !loaded)
        {
            userId = await LocalStorage.GetItemAsync<int>("userId");
            authToken = await LocalStorage.GetItemAsync<string>("authToken");

            if (userId.ToString() != null && authToken != null)
            {
                await getOrdersByCustomer();
                isPageLoading = false;
            }
            else
            {
                Nav.NavigateTo("/login", true); // true = force reload
            }
            StateHasChanged();
        }
    }

    void SelectRating(int rating)
    {
        feedbackRequest.Rating = rating;
    }
    private async Task getOrdersByCustomer()
    {
        var response = await OrderService.GetOrderByCustomerId(userId); // Now returns list

        if (response?.Success == true && response.Data != null && response.Data.Any())
        {
            orders = response.Data.OrderByDescending(o => o.Id).ToList();   // Store list of orders

            foreach (var order in orders)
            {
                var billing = await AddressService.GetAddressByIdAsync(order.BillingAddressId);
                var shipping = await AddressService.GetAddressByIdAsync(order.ShippingAddressId);

                if (billing == null || shipping == null)
                {
                    errorAlert = "One or more addresses are missing.";
                }

                BillingAddresses[order.Id] = billing;
                ShippingAddresses[order.Id] = shipping;

                foreach (var item in order.OrderItems)
                {
                    var product = await ProductService.GetProductByIdAsync(item.ProductId);
                    ProductDetails[item.ProductId] = product;
                }
            }

        }
        else
        {
            errorAlert = "No Orders Found.";
        }

    }
    private void PayOrder(int Id)
    {

    }


    bool isPaymentModalOpen = false;
    bool isFeedbackModalOpen = false;

    private PaymentRequestDTO paymentRequest = new();
    private StripeCheckoutDTO stripeCheckoutRequest = new();
    private FeedbackCreateDTO feedbackRequest = new();

    List<string> paymentMethods = new()
    {
        "Cash on Delivery",
        "VISA",
        "Mastercard",
        "JazzCash",
        "Easypaisa",
        "Stripe"
    };
    Dictionary<string, string> paymentIcons = new()
    {
        { "Cash on Delivery", "https://th.bing.com/th/id/OIP.0QTwObaauPQ1UppvH7syUAHaHa?w=199&h=199&c=7&r=0&o=7&cb=ucfimgc2&dpr=1.4&pid=1.7&rm=3" },
        { "VISA", "https://www.bing.com/th/id/OIP.hZnh7WR7hlMrODsM3FHS9wHaHa?w=183&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" },
        { "Mastercard", "https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" },
        { "JazzCash", "https://www.bing.com/th/id/OIP.05InOB5Bm1QISVw_MPAqjgHaHa?w=183&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" },
        { "Easypaisa", "https://www.bing.com/th/id/OIP.QcS8e3iGamNXsvBeJKd3FQHaHa?w=195&h=211&c=8&rs=1&qlt=90&o=6&cb=ucfimgc1&dpr=1.4&pid=3.1&rm=2" },
        { "Stripe", "https://th.bing.com/th/id/OIP.1CF86fA0oXP1g6g5MdcGygHaDc?w=296&h=150&c=6&o=7&cb=ucfimgc2&dpr=1.3&pid=1.7&rm=3" }
    };


    private void OpenPaymentModal(OrderResponseDTO order)
    {
        paymentRequest.CustomerId = userId;
        paymentRequest.OrderId = order.Id;
        paymentRequest.Amount = order.TotalAmount;

        //Stripe
        var productId = order.OrderItems.First().ProductId;

        stripeCheckoutRequest.ProductName = @ProductDetails[productId].Data.Name;
        stripeCheckoutRequest.Quantity = order.OrderItems.First().Quantity;
        stripeCheckoutRequest.UnitPrice = (long)order.OrderItems.First().UnitPrice;
        stripeCheckoutRequest.BaseUrl = Nav.BaseUri.TrimEnd('/');
        stripeCheckoutRequest.Currency = "PKR";
        stripeCheckoutRequest.CustomerId = order.CustomerId;
        stripeCheckoutRequest.OrderId = order.Id;



        isPaymentModalOpen = true;
    }

    void ClosePaymentModal()
    {
        isPaymentModalOpen = false;
    }
    private void OpenFeedbackModal(OrderResponseDTO order)
    {
        feedbackRequest.CustomerId = userId;
        // feedbackRequest.ProductId = order.OrderItems.;
        orderId = order.Id;
        isFeedbackModalOpen = true;
    }
    void CloseFeedbackModal()
    {
        isFeedbackModalOpen = false;
    }

    void PaymentDetails(int Id)
    {
        Nav.NavigateTo($"/payment-details/{Id}");
    }
    void SelectMethod(string method)
    {
        paymentRequest.PaymentMethod = method;
    }

    // Submit Feedback
    async Task SubmitFeedBack()
    {
        isLoading = true;

        var response = await FeedbackService.RequestFeedback(feedbackRequest);
        if (response.Success)
        {
            isLoading = false;
            isFeedback = true;
            StateHasChanged();
        }
        else
        {
            errorAlert = $"{response.Errors}";
        }

    }

    void SelectProduct(int productId)
    {
        feedbackRequest.ProductId = productId;
        StateHasChanged();
    }
    private async Task SubmitPayment()
    {
        if (string.IsNullOrEmpty(paymentRequest.PaymentMethod))
        {
            alert = "Please select a payment method.";
            StateHasChanged();
            return;
        }

        try
        {
            isLoading = true;
            alert = null;
            StateHasChanged();

            if (paymentRequest.PaymentMethod == "Stripe")
            {
                stripeCheckoutRequest.PaymentMethod = paymentRequest.PaymentMethod;
                var result = await PaymentService.CreateCheckoutSession(stripeCheckoutRequest);

                if (result != null && result.Data != null)
                {
                    Nav.NavigateTo(result.Data.Url, forceLoad: true);

                }
                else
                {
                    errorAlert = "Payment session could not be created.";
                }

            }
            else
            {
                var response = await PaymentService.ProcessPaymentAsync(paymentRequest);

                if (response?.Success == true)
                {
                    alert = "Payment successful!";
                    var order = orders.FirstOrDefault(o => o.Id == paymentRequest.OrderId);
                    if (order != null)
                    {
                        order.OrderStatus = OrderStatus.Processing;
                    }
                }
                else
                {
                    errorAlert = $"{response?.Errors}";
                }
            }

            
        }
        catch (Exception ex)
        {
            alert = $"Payment error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            isPaymentModalOpen = false;
            StateHasChanged();
        }

    }

    // Cancel Modal
    private bool isCancelModalOpen = false;

    private CancellationRequestDTO cancelRequest = new();

    // [Parameter] public List<OrderResponseDTO>? orders { get; set; }

    private void OpenCancelModal(int orderId, int customerId)
    {
        cancelRequest.OrderId = orderId;
        cancelRequest.CustomerId = customerId;
        cancelRequest.Reason = "";
        isCancelModalOpen = true;
    }

    private void CloseCancelModal() => isCancelModalOpen = false;

    private async Task SubmitCancellation()
    {
        var response = await CancellationService.CancelOrderAsync(cancelRequest);
        if (response.Success)
        {
            isCancelModalOpen = false;
            StateHasChanged();
        }
        else
        {
            errorAlert = (string.Join(", ", response.Errors ?? new List<string> { "Failed to cancel order." }));
        }
    }




}
